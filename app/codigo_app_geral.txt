-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\base.html --
<!doctype html>
<html lang="pt">
  <head>
    <meta charset="utf-8">
    <title>{% block title %}AdGest{% endblock %}</title>

    <!-- FontAwesome (ou outra biblioteca de ícones) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >
    <!-- Seu CSS customizado (opcional) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('main.index') }}">AdGest</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="navbarNotifications" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fa-solid fa-bell"></i>
                {% if unread_count > 0 %}
                  <span class="badge bg-danger">{{ unread_count }}</span>
                {% endif %}
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarNotifications">
                {% for notif in notifications %}
                  <li class="dropdown-item d-flex justify-content-between align-items-start">
                    <div>
                      {{ notif.message }}  
                      <br><small class="text-muted">{{ notif.timestamp.strftime('%d/%m/%Y %H:%M') }}</small>
                    </div>
                    <!-- Botão para marcar como lida via AJAX ou form -->
                    <form method="POST" onsubmit="return markAsRead(event, {{ notif.id }})">
                      <button class="btn btn-sm btn-outline-secondary ms-2" type="submit">Marcar como Lida</button>
                    </form>
                  </li>
                {% else %}
                  <li><span class="dropdown-item">Nenhuma notificação</span></li>
                {% endfor %}
                <li><hr class="dropdown-divider"></li>
                <li>
                  <a class="dropdown-item text-center" href="{{ url_for('main.notifications_historico') }}">
                    Ver Histórico de Notificações
                  </a>
                </li>
              </ul>
            </li>            
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('main.dashboard') }}">Gestão Diária</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('main.clientes') }}">Clientes</a>
            </li>
            {% if current_user.is_authenticated and current_user.role not in ['contabilidade', 'backoffice'] %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('main.billing') }}">Billing</a>
            </li>
            {% endif %}
            {% if current_user.is_authenticated and current_user.role in ['contabilidade', 'admin'] %}
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('accounting.manage_invoices') }}">
                  Contabilidade
                </a>
              </li>
            {% endif %}
            {% if current_user.is_authenticated %}
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('main.logout') }}">Logout</a>
              </li>
              {% if current_user.role == 'admin' %}
                <li class="nav-item">
                  <a class="nav-link" href="{{ url_for('main.register') }}">Registrar</a>
                </li>
              {% endif %}
            {% else %}
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('main.login') }}">Login</a>
              </li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    <!-- Área principal do site -->
    <div class="container mt-3">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </div>

    <!-- Bootstrap JS (inclui Popper.js) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Seu JS customizado (opcional) -->
    <script src="{{ url_for('static', filename='js/custom.js') }}"></script>

    <!-- Função JavaScript para marcar notificações como lidas -->
    <script>
      function markAsRead(event, notifId) {
        event.preventDefault(); // evita recarregar a página
        fetch("{{ url_for('main.mark_notification_read', notif_id=0) }}".replace("0", notifId), {
          method: "POST"
        })
        .then(response => {
          if (response.ok) {
            // Reload da página para atualizar o dropdown
            window.location.reload();
          } else {
            alert("Erro ao marcar notificação como lida.");
          }
        })
        .catch(err => console.error(err));
        return false;
      }
    </script>
  </body>
</html>


--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\billing_cliente.html --
{% extends "base.html" %}
{% block title %}Notas Emitidas - {{ client.name }}{% endblock %}
{% block content %}
<div class="container">
  <h2 class="text-center my-4">Notas de Honorários Emitidas para {{ client.name }}</h2>
  {% if billing_notes %}
    <div id="clientBillingCarousel" class="carousel slide" data-bs-interval="false">
      <div class="carousel-inner">
        {% for note in billing_notes %}
          <div class="carousel-item {% if loop.first %}active{% endif %}">
            <div class="card">
              <div class="card-header">
                Nota #{{ note.id }}
              </div>
              <div class="card-body">
                <p><strong>Data de Emissão:</strong> {{ note.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
                <p><strong>Total de Horas:</strong> {{ note.total_hours }}h</p>
                <pre style="white-space: pre-wrap;">{{ note.details }}</pre>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
      <button class="carousel-control-prev" type="button" data-bs-target="#clientBillingCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Anterior</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#clientBillingCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Próximo</span>
      </button>
    </div>
  {% else %}
    <p>Nenhuma nota emitida para este cliente.</p>
  {% endif %}
  <a href="{{ url_for('main.clientes') }}" class="btn btn-secondary mt-3">Voltar à lista de clientes</a>
</div>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\billing_grouped.html --
{% extends "base.html" %}
{% block title %}Notas de Honorários{% endblock %}
{% block content %}
<div class="text-center mb-4">
  <h2>Notas de Honorários</h2>
</div>
<div class="row">
  <!-- Coluna dos Itens a Processar -->
  <div class="col-md-6">
    <h3>Por Processar</h3>
    <form method="POST" id="billingForm">
      {% for client_id, group in grouped_data.items() %}
        <div class="mb-3">
          <h4>Cliente: {{ group.client.name }}</h4>
          {# Exibe os assuntos e suas tarefas #}
          {% for assunto_id, a_data in group.assuntos.items() %}
            <div class="ms-3 mb-2">
              <label class="{% if a_data.assunto.shared_with.count() > 0 %}shared-item{% endif %}">
                <input type="checkbox" name="items" value="assunto-{{ a_data.assunto.id }}" class="subject-checkbox">
                <strong>Assunto:</strong> {{ a_data.assunto.nome_assunto }} - Total Horas (tarefas): {{ a_data.assunto.tarefas|map(attribute='horas')|sum }}h
              </label>
              <!-- Link para reverter faturamento do assunto -->
              <a href="#" class="btn btn-sm btn-warning" onclick="revertItem('assunto', {{ a_data.assunto.id }}); return false;">Reverter</a>
              {% if a_data.tarefas %}
                <ul>
                  {% for tarefa in a_data.tarefas %}
                    <li>
                      <label class="{% if tarefa.shared_with.count() > 0 %}shared-item{% endif %}">
                        <input type="checkbox" name="items" value="tarefa-{{ tarefa.id }}" data-subject-id="{{ a_data.assunto.id }}">
                        <strong>Tarefa:</strong> {{ tarefa.nome_tarefa }},
                        Horas: {{ tarefa.horas }}h,
                        Concluída em: {% if tarefa.data_conclusao %}{{ tarefa.data_conclusao.strftime('%d/%m/%Y') }}{% else %}N/A{% endif %}
                      </label>
                      <!-- Link para reverter faturamento da tarefa -->
                      <a href="#" class="btn btn-sm btn-warning" onclick="revertItem('tarefa', {{ tarefa.id }}); return false;">Reverter</a>
                    </li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
          {% endfor %}
          {# Exibe os prazos do cliente #}
          {% if group.prazos %}
            <div class="ms-3 mb-2">
              <strong>Prazos:</strong>
              <ul>
                {% for prazo in group.prazos %}
                  <li>
                    <label class="{% if prazo.shared_with.count() > 0 %}shared-item{% endif %}">
                      <input type="checkbox" name="items" value="prazo-{{ prazo.id }}">
                      <strong>{{ prazo.assunto }}</strong> – Processo: {{ prazo.processo }}, Horas: {{ prazo.horas }}h,
                      Data: {% if prazo.prazo %}{{ prazo.prazo.strftime('%d/%m/%Y') }}{% else %}Sem data{% endif %}
                    </label>
                    <!-- Link para reverter faturamento do prazo -->
                    <a href="#" class="btn btn-sm btn-warning" onclick="revertItem('prazo', {{ prazo.id }}); return false;">Reverter</a>
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
        </div>
      {% endfor %}
      <button type="submit" class="btn btn-primary">Gerar Nota de Honorários</button>
    </form>
  </div>
  
  <!-- Coluna do Histórico de Notas -->
  <div class="col-md-6">
    <h3>Notas Emitidas</h3>
    {% if nota_honorarios and nota_honorarios|length > 0 %}
      <div id="billingCarousel" class="carousel slide" data-bs-interval="false">
        <div class="carousel-inner">
          {% for nota in nota_honorarios %}
            <div class="carousel-item {% if loop.first %}active{% endif %}">
              <div class="card">
                <div class="card-header">
                  Nota #{{ nota.id }} – {{ nota.client.name }}
                </div>
                <div class="card-body">
                  <p><strong>Data:</strong> {{ nota.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
                  <p><strong>Total de Horas:</strong> {{ nota.total_hours }}h</p>
                  <pre style="white-space: pre-wrap;">{{ nota.details }}</pre>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#billingCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Anterior</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#billingCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Próximo</span>
        </button>
      </div>
    {% else %}
      <p>Nenhuma nota emitida ainda.</p>
    {% endif %}
    <div class="mt-3">
      <a href="{{ url_for('main.billing_historico') }}" class="btn btn-secondary">Ver Histórico de Notas</a>
    </div>
  </div>
</div>

<script>
  // Gera a URL de base para reverter, usando um valor dummy para item_id e um placeholder para item_type
  var revertBillingUrlTemplate = "{{ url_for('main.revert_billing', item_type='__ITEM_TYPE__', item_id=9999999) }}";
  // Gera a URL para o billing, para redirecionamento após a operação
  var billingUrl = "{{ url_for('main.billing') }}";
  
  // Script de seleção automática de tarefas relacionadas ao marcar um assunto
  document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.subject-checkbox').forEach(function(subjectCheckbox) {
          subjectCheckbox.addEventListener('change', function() {
              var subjectId = this.value.split('-')[1];
              document.querySelectorAll('input[type="checkbox"][name="items"][data-subject-id="' + subjectId + '"]').forEach(function(taskCheckbox) {
                  taskCheckbox.checked = subjectCheckbox.checked;
              });
          });
      });
  });
  
  // Função para reverter um item via fetch (sem CSRF header)
  function revertItem(itemType, itemId) {
      // Substitui os placeholders na URL com os valores reais
      var url = revertBillingUrlTemplate.replace("__ITEM_TYPE__", itemType).replace("9999999", itemId);
      fetch(url, { method: "POST" })
          .then(function(response) {
              if(response.ok) {
                  window.location.href = billingUrl;
              } else {
                  alert("Erro ao reverter o faturamento.");
              }
          })
          .catch(function(error) {
              alert("Erro ao reverter o faturamento.");
          });
  }
  </script>
  
{% endblock %}

  
--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\billing_historico.html --
{% extends "base.html" %}
{% block title %}Histórico de Notas{% endblock %}
{% block content %}
<div class="container">
  <h2 class="text-center my-4">Histórico de Notas de Honorários</h2>

  <!-- Formulário de Filtros -->
  <form method="GET" action="{{ url_for('main.billing_historico') }}" class="mb-4">
    <div class="row g-3">
      <div class="col-md-3">
        <label for="cliente" class="form-label">Cliente</label>
        <input type="text" class="form-control" id="cliente" name="cliente" value="{{ request.args.get('cliente', '') }}">
      </div>
      <div class="col-md-3">
        <label for="data_emissao" class="form-label">Data de Emissão</label>
        <input type="date" class="form-control" id="data_emissao" name="data_emissao" value="{{ request.args.get('data_emissao', '') }}">
      </div>
      <div class="col-md-3">
        <label for="min_horas" class="form-label">Horas Mínimas</label>
        <input type="number" step="0.1" class="form-control" id="min_horas" name="min_horas" value="{{ request.args.get('min_horas', '') }}">
      </div>
      <div class="col-md-3">
        <label for="processo" class="form-label">Número do Processo</label>
        <input type="text" class="form-control" id="processo" name="processo" value="{{ request.args.get('processo', '') }}">
      </div>
    </div>
    <div class="row mt-3">
      <div class="col">
        <button type="submit" class="btn btn-primary">Filtrar</button>
        <a href="{{ url_for('main.billing_historico') }}" class="btn btn-secondary">Limpar Filtros</a>
      </div>
    </div>
  </form>

  <!-- Exibição das Notas -->
  {% if nota_honorarios %}
    <div class="list-group">
      {% for nota in nota_honorarios %}
        <div class="list-group-item">
          <h5>Nota #{{ loop.index }} – Cliente: {{ nota.client.name }}</h5>
          <p><strong>Data:</strong> {{ nota.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
          <p><strong>Total de Horas:</strong> {{ nota.total_hours }}h</p>
          <pre>{{ nota.details }}</pre>
        </div>
      {% endfor %}
    </div>
    {% set args = request.args.to_dict() %}
    {% set _ = args.pop('page', None) %}
    <nav aria-label="Page navigation" class="mt-4">
      <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('main.billing_historico', page=pagination.prev_num, **args) }}">Anterior</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Anterior</span></li>
        {% endif %}
        {% for page in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
          {% if page %}
            {% if page == pagination.page %}
              <li class="page-item active"><span class="page-link">{{ page }}</span></li>
            {% else %}
              <li class="page-item"><a class="page-link" href="{{ url_for('main.billing_historico', page=page, **args) }}">{{ page }}</a></li>
            {% endif %}
          {% else %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
          {% endif %}
        {% endfor %}
        {% if pagination.has_next %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('main.billing_historico', page=pagination.next_num, **args) }}">Próximo</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Próximo</span></li>
        {% endif %}
      </ul>
    </nav>
  {% else %}
    <p>Nenhuma nota emitida.</p>
  {% endif %}
  <div class="mt-3">
    <a href="{{ url_for('main.billing') }}" class="btn btn-secondary">Voltar ao Billing</a>
  </div>
</div>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\clientes.html --
{% extends "base.html" %}
{% block title %}Clientes{% endblock %}
{% block content %}
<div class="container my-4">
  <h2 class="mb-4 text-center">Lista de Clientes</h2>
  
  <!-- Botão Criar Cliente e CSV -->
  <div class="text-end mb-3">
    <a href="{{ url_for('main.upload_client_csv') }}" class="btn btn-outline-primary">Importar Clientes CSV</a>
    <a href="{{ url_for('main.create_client') }}" class="btn btn-success">+ Criar Cliente</a>
  </div>
  
  <!-- Caixa de pesquisa -->
  <form method="GET" action="{{ url_for('main.clientes') }}" class="mb-3">
    <input type="text" name="q" id="clientSearch" class="form-control" placeholder="Pesquisar cliente (nome ou número interno)..." value="{{ search }}">
  </form>

  <!-- Exibição dos clientes em cards -->
  <div class="row" id="clientList">
    {% for client in clients %}
      <div class="col-md-4 mb-3 client-card">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">{{ client.name }}</h5>
            {% if client.number_interno %}
              <h6 class="card-subtitle mb-2 text-muted">{{ client.number_interno }}</h6>
            {% endif %}
            <p class="card-text">
              {% if client.email %}Email: {{ client.email }}<br>{% endif %}
              {% if client.telephone %}Tel: {{ client.telephone }}{% endif %}
            </p>
          </div>
          <div class="card-footer d-flex justify-content-between align-items-center">
            <div>
              <a href="{{ url_for('main.client_info', client_id=client.id) }}" class="btn btn-primary btn-sm">Info</a>
              <a href="{{ url_for('main.historico_cliente', client_id=client.id) }}" class="btn btn-info btn-sm">Histórico</a>
              {% if current_user.role == 'admin' %}
                <a href="{{ url_for('main.billing_cliente', client_id=client.id) }}" class="btn btn-success btn-sm">Billing</a>
                <a href="{{ url_for('main.contabilidade_cliente', client_id=client.id) }}" class="btn btn-secondary btn-sm">Contabilidade</a>
              {% elif current_user.role == 'advogado' %}
                <a href="{{ url_for('main.billing_cliente', client_id=client.id) }}" class="btn btn-success btn-sm">Billing</a>
              {% else %}
                <a href="{{ url_for('main.contabilidade_cliente', client_id=client.id) }}" class="btn btn-secondary btn-sm">Contabilidade</a>
              {% endif %}
            </div>
          </div>                                                 
        </div>
      </div>
    {% endfor %}
  </div>
  
  <!-- Controles de paginação -->
  {% if pagination.pages > 1 %}
    <nav aria-label="Page navigation" class="mt-4">
      <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('main.clientes', page=pagination.prev_num, q=search) }}">Anterior</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Anterior</span></li>
        {% endif %}
        {% for page in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
          {% if page %}
            {% if page == pagination.page %}
              <li class="page-item active"><span class="page-link">{{ page }}</span></li>
            {% else %}
              <li class="page-item"><a class="page-link" href="{{ url_for('main.clientes', page=page, q=search) }}">{{ page }}</a></li>
            {% endif %}
          {% else %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
          {% endif %}
        {% endfor %}
        {% if pagination.has_next %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('main.clientes', page=pagination.next_num, q=search) }}">Próximo</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Próximo</span></li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
</div>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\client_info.html --
{% extends "base.html" %}
{% block title %}Informação do Cliente - {{ client.name }}{% endblock %}
{% block content %}
<div class="container">
  <h2 class="text-center my-4">Informação do Cliente</h2>
  <div class="card">
    <div class="card-body">
      <h4>{{ client.name }}</h4>
      {% if client.number_interno %}
        <p><strong>Número Interno:</strong> {{ client.number_interno }}</p>
      {% endif %}
      {% if client.nif %}
        <p><strong>NIF:</strong> {{ client.nif }}</p>
      {% endif %}
      {% if client.address %}
        <p><strong>Morada:</strong> {{ client.address }}</p>
      {% endif %}
      {% if client.email %}
        <p><strong>Email:</strong> {{ client.email }}</p>
      {% endif %}
      {% if client.telephone %}
        <p><strong>Telefone:</strong> {{ client.telephone }}</p>
      {% endif %}
    </div>
  </div>
  <div class="mt-3">
    <a href="{{ url_for('main.edit_client', client_id=client.id) }}" class="btn btn-warning">Editar</a>
    <a href="{{ url_for('main.clientes') }}" class="btn btn-secondary">Voltar</a>
  </div>
</div>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\confirm_client_csv_import.html --
{% extends "base.html" %}
{% block title %}Confirmar Importação de Clientes{% endblock %}
{% block content %}
<div class="container my-4">
  <h2>Confirmar Importação dos Clientes</h2>
  <p>Revise os registros abaixo e, se estiver tudo correto, confirme a importação.</p>
  <table class="table table-bordered">
    <thead>
      <tr>
        {% for col in registros[0].keys() %}
          <th>{{ col }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in registros %}
        <tr>
          {% for col in row.keys() %}
            <td>{{ row[col] }}</td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
  <form method="POST" action="{{ url_for('main.confirm_client_csv_import') }}">
    {{ form.hidden_tag() if form is defined }}
    <button type="submit" class="btn btn-success">Confirmar Importação</button>
  </form>
</div>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\create_assunto.html --
{% extends "base.html" %}
{% block title %}Criar/Editar Assunto{% endblock %}
{% block content %}
  <h2>Criar/Editar Assunto</h2>
  <form method="POST">
    {{ form.hidden_tag() }}

    {% if form.errors %}
      <div class="alert alert-danger">
        <ul>
          {% for field, errors in form.errors.items() %}
            {% for error in errors %}
              <li>{{ field }}: {{ error }}</li>
            {% endfor %}
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <div class="mb-3">
      {{ form.client_existing.label }}<br>
      {{ form.client_existing(class="form-control") }}
    </div>
    <div class="mb-3">
      {{ form.client_new.label }}<br>
      {{ form.client_new(class="form-control") }}
    </div>
    <div class="mb-3">
      {{ form.nome_assunto.label }}<br>
      {{ form.nome_assunto(class="form-control") }}
    </div>
    <div class="mb-3">
      {{ form.due_date.label }}<br>
      {{ form.due_date(type="date", class="form-control") }}
    </div>
    <div class="mb-3">
      {{ form.sort_order.label }}<br>
      {{ form.sort_order(class="form-control") }}
    </div>
    <div>
      {{ form.submit(class="btn btn-primary") }}
    </div>
  </form>
  <p><a href="{{ url_for('main.dashboard') }}" class="btn btn-link">Voltar</a></p>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\create_client.html --
{% extends "base.html" %}
{% import "macros.html" as macros %}
{% block title %}Criar Cliente{% endblock %}
{% block content %}
<div class="container">
  <h2 class="text-center my-4">Criar Novo Cliente</h2>
  <form method="POST" class="needs-validation" novalidate>
    {{ form.hidden_tag() }}
    {{ macros.render_field(form.name) }}
    {{ macros.render_field(form.number_interno) }}
    {{ macros.render_field(form.nif) }}
    {{ macros.render_field(form.address) }}
    {{ macros.render_field(form.email) }}
    {{ macros.render_field(form.telephone) }}
    <button type="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
    <a href="{{ url_for('main.clientes') }}" class="btn btn-secondary">Voltar</a>
  </form>
</div>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\create_tarefa.html --
{% extends "base.html" %}
{% import "macros.html" as macros %}
{% block title %}Criar Tarefa{% endblock %}
{% block content %}
<h2>Criar Tarefa para o Assunto: {{ assunto.nome_assunto }}</h2>
<form method="POST" class="needs-validation" novalidate>
  {{ form.hidden_tag() }}
  {{ macros.render_field(form.nome_tarefa) }}
  {{ macros.render_field(form.descricao) }}
  {{ macros.render_field(form.due_date) }}
  {{ macros.render_field(form.sort_order) }}
  {{ macros.render_field(form.horas) }}
  <button type="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
</form>
<p><a href="{{ url_for('main.dashboard') }}" class="btn btn-link">Voltar</a></p>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\dashboard.html --
{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<div class="container my-4">
  <!-- Linha superior: 3 janelinhas colapsáveis + botões à direita -->
  <div class="row align-items-start mb-3">
    <!-- JANELINHA HOJE -->
    <div class="col-md-2">
      <div class="card">
        <!-- Cabeçalho colapsável -->
        <div class="card-header p-2">
          <button class="btn btn-sm btn-light text-dark w-100 fs-5 text-start"
                  type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseHoje"
                  aria-expanded="false"
                  aria-controls="collapseHoje">
            Hoje <i class="fa-solid fa-angle-down float-end"></i>
          </button>
        </div>        
        <!-- Corpo colapsado -->
        <div id="collapseHoje" class="collapse">
          <div class="card-body" style="max-height: 220px; overflow-y: auto;">
            <!-- Assuntos e Tarefas de HOJE -->
            {% for assunto in assuntos %}
              {% set tarefas_hoje = [] %}
              {% for tarefa in assunto.tarefas %}
                {% if tarefa.due_date and tarefa.due_date <= current_date %}
                  {% set _ = tarefas_hoje.append(tarefa) %}
                {% endif %}
              {% endfor %}
              {% set assunto_e_hoje = (assunto.due_date and assunto.due_date <= current_date) %}
              {% if assunto_e_hoje or tarefas_hoje|length > 0 %}
                <div class="mb-2">
                  <strong>{{ assunto.nome_assunto }}</strong> - <em>{{ assunto.client.name }}</em>
                  {% if assunto_e_hoje %}
                    {% if tarefas_hoje %}
                      <ul class="list-group mt-1">
                        {% for t in tarefas_hoje %}
                          <li class="list-group-item p-1">{{ t.nome_tarefa }}</li>
                        {% endfor %}
                      </ul>
                    {% else %}
                      <small class="text-muted">Nenhuma tarefa de hoje</small>
                    {% endif %}
                  {% else %}
                    <ul class="list-group mt-1">
                      {% for t in tarefas_hoje %}
                        <li class="list-group-item p-1">{{ t.nome_tarefa }}</li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                </div>
              {% endif %}
            {% endfor %}

            <!-- Prazos de HOJE -->
            <h6 class="mt-2">Prazos</h6>
            {% for prazo in prazos %}
              {% if prazo.prazo and prazo.prazo <= current_date %}
                <div class="mb-2">
                  <strong>{{ prazo.assunto }}</strong> - <em>{{ prazo.client.name }}</em>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- JANELINHA AMANHÃ -->
    <div class="col-md-2">
      <div class="card">
        <div class="card-header p-2">
          <button class="btn btn-sm btn-light text-dark w-100 fs-5 text-start"
                  type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseAmanha"
                  aria-expanded="false"
                  aria-controls="collapseAmanha">
            Amanhã <i class="fa-solid fa-angle-down float-end"></i>
          </button>
        </div>
        <div id="collapseAmanha" class="collapse">
          <div class="card-body" style="max-height: 220px; overflow-y: auto;">
            <!-- Assuntos e Tarefas de AMANHÃ -->
            {% for assunto in assuntos %}
              {% set tarefas_amanha = [] %}
              {% for tarefa in assunto.tarefas %}
                {% if tarefa.due_date and tarefa.due_date == tomorrow_date %}
                  {% set _ = tarefas_amanha.append(tarefa) %}
                {% endif %}
              {% endfor %}
              {% set assunto_e_amanha = (assunto.due_date and assunto.due_date == tomorrow_date) %}
              {% if assunto_e_amanha or tarefas_amanha|length > 0 %}
                <div class="mb-2">
                  <strong>{{ assunto.nome_assunto }}</strong> - <em>{{ assunto.client.name }}</em>
                  {% if assunto_e_amanha %}
                    {% if tarefas_amanha %}
                      <ul class="list-group mt-1">
                        {% for t in tarefas_amanha %}
                          <li class="list-group-item p-1">{{ t.nome_tarefa }}</li>
                        {% endfor %}
                      </ul>
                    {% else %}
                      <small class="text-muted">Nenhuma tarefa para amanhã</small>
                    {% endif %}
                  {% else %}
                    <ul class="list-group mt-1">
                      {% for t in tarefas_amanha %}
                        <li class="list-group-item p-1">{{ t.nome_tarefa }}</li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                </div>
              {% endif %}
            {% endfor %}

            <!-- Prazos de AMANHÃ -->
            <h6 class="mt-2">Prazos</h6>
            {% for prazo in prazos %}
              {% if prazo.prazo and prazo.prazo == tomorrow_date %}
                <div class="mb-2">
                  <strong>{{ prazo.assunto }}</strong> - <em>{{ prazo.client.name }}</em>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- JANELINHA DEPOIS -->
    <div class="col-md-2">
      <div class="card">
        <div class="card-header p-2">
          <button class="btn btn-sm btn-light text-dark w-100 fs-5 text-start"
                  type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseDepois"
                  aria-expanded="false"
                  aria-controls="collapseDepois">
            Depois <i class="fa-solid fa-angle-down float-end"></i>
          </button>
        </div>
        <div id="collapseDepois" class="collapse">
          <div class="card-body" style="max-height: 220px; overflow-y: auto;">
            <!-- Assuntos e Tarefas DEPOIS -->
            {% for assunto in assuntos %}
              {% set tarefas_depois = [] %}
              {% for tarefa in assunto.tarefas %}
                {% if not tarefa.due_date or tarefa.due_date > tomorrow_date %}
                  {% set _ = tarefas_depois.append(tarefa) %}
                {% endif %}
              {% endfor %}
              {% set assunto_e_depois = (not assunto.due_date or assunto.due_date > tomorrow_date) %}
              {% if assunto_e_depois or tarefas_depois|length > 0 %}
                <div class="mb-2">
                  <strong>{{ assunto.nome_assunto }}</strong> - <em>{{ assunto.client.name }}</em>
                  {% if assunto_e_depois %}
                    {% if tarefas_depois %}
                      <ul class="list-group mt-1">
                        {% for t in tarefas_depois %}
                          <li class="list-group-item p-1">{{ t.nome_tarefa }}</li>
                        {% endfor %}
                      </ul>
                    {% else %}
                      <small class="text-muted">Nenhuma tarefa para depois</small>
                    {% endif %}
                  {% else %}
                    <ul class="list-group mt-1">
                      {% for t in tarefas_depois %}
                        <li class="list-group-item p-1">{{ t.nome_tarefa }}</li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                </div>
              {% endif %}
            {% endfor %}

            <!-- Prazos DEPOIS -->
            <h6 class="mt-2">Prazos</h6>
            {% for prazo in prazos %}
              {% if not prazo.prazo or prazo.prazo > tomorrow_date %}
                <div class="mb-2">
                  <strong>{{ prazo.assunto }}</strong> - <em>{{ prazo.client.name }}</em>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- Coluna Botões à Direita -->
    <div class="col d-flex justify-content-end">
      <a href="{{ url_for('main.create_assunto') }}" class="btn btn-primary me-2">
        <i class="fa-solid fa-plus"></i> Criar Assunto
      </a>
      <a href="{{ url_for('main.create_prazo') }}" class="btn btn-secondary">
        <i class="fa-solid fa-plus"></i> Criar Prazo
      </a>
    </div>
  </div>

  <!-- Linha inferior: Assuntos e Prazos lado a lado -->
  <div class="row">
    <!-- Coluna Assuntos -->
    <div class="col-lg-8">
      <h4 class="mb-3">Assuntos</h4>
      <div id="assuntos-container" class="row row-cols-1 row-cols-lg-2 g-3">
        {% for assunto in assuntos %}
        <div class="col" data-id="{{ assunto.id }}">
          <div class="card h-100">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <h5 class="mb-0 flex-grow-1" style="white-space: normal;">
                  {{ assunto.nome_assunto }}
                </h5>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <div class="dropdown">
                  <button class="btn btn-sm btn-light dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fa-solid fa-share-nodes"></i>
                    {{ assunto.user.nickname }}{% for usuario in assunto.shared_with %} / {{ usuario.nickname }}{% endfor %}
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                      <a class="dropdown-item" href="{{ url_for('main.share_assunto', assunto_id=assunto.id) }}">
                        <i class="fa-solid fa-share-nodes"></i> Compartilhar
                      </a>
                    </li>
                  </ul>
                </div>                                             
                <div class="d-flex align-items-center gap-2">
                  <form action="{{ url_for('main.toggle_status_assunto', assunto_id=assunto.id) }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-success" title="Concluir">
                      <i class="fa-solid fa-check"></i>
                    </button>
                  </form>
                  <a href="{{ url_for('main.edit_assunto', assunto_id=assunto.id) }}" class="btn btn-sm btn-warning" title="Editar">
                    <i class="fa-solid fa-pen-to-square"></i>
                  </a>
                  <form action="{{ url_for('main.delete_assunto', assunto_id=assunto.id) }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-danger" title="Excluir">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </form>
                </div>
              </div>
            </div>
            <div class="card-body">
              {% set total_horas = 0 %}
              {% for tarefa in assunto.tarefas %}
                {% if tarefa.horas %}
                  {% set total_horas = total_horas + tarefa.horas %}
                {% endif %}
              {% endfor %}
              <p class="mb-2" style="white-space: normal;">
                <strong>Cliente:</strong> {{ assunto.client.name }} |
                <strong>Data:</strong>
                {% if assunto.due_date %}
                  {{ assunto.due_date.strftime('%d/%m/%Y') }}
                {% else %}
                  Sem data
                {% endif %}
                | <i class="fa-solid fa-clock"></i> {{ total_horas|default(0) }}h
              </p>
              <!-- Botão para mostrar Tarefas -->
              <button class="btn btn-primary mb-2" type="button" data-bs-toggle="collapse"
                      data-bs-target="#tarefas-{{ assunto.id }}" aria-expanded="false" aria-controls="tarefas-{{ assunto.id }}">
                <i class="fa-solid fa-eye"></i> Tarefas
              </button>
              <div class="collapse" id="tarefas-{{ assunto.id }}">
                <ul class="list-group mb-3">
                  {% for tarefa in assuntos_tarefas_visiveis[assunto.id] if not tarefa.is_completed %}
                    <li class="list-group-item">
                      <!-- Primeira linha: Botões principais -->
                      <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="flex-grow-1">
                          <strong>{{ tarefa.nome_tarefa }}</strong>
                          {% if tarefa.descricao %}
                            <em>({{ tarefa.descricao }})</em>
                          {% endif %}
                        </div>
                        <div class="d-flex gap-1">
                          <!-- Botão Concluir -->
                          <form action="{{ url_for('main.toggle_status_tarefa', tarefa_id=tarefa.id) }}" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-success" title="Concluir">
                              <i class="fa-solid fa-check"></i>
                            </button>
                          </form>
                          <!-- Botão Editar -->
                          <a href="{{ url_for('main.edit_tarefa', tarefa_id=tarefa.id) }}" class="btn btn-sm btn-warning" title="Editar">
                            <i class="fa-solid fa-pen-to-square"></i>
                          </a>
                          <!-- Botão Excluir -->
                          <form action="{{ url_for('main.delete_tarefa', tarefa_id=tarefa.id) }}" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-danger" title="Excluir">
                              <i class="fa-solid fa-trash"></i>
                            </button>
                          </form>
                        </div>
                      </div>
                      <!-- Segunda linha: Botão Compartilhar (dropdown) + Botão Adicionar Horas, alinhados à direita -->
                      <div class="d-flex justify-content-end align-items-center gap-2 mt-2">
                        <!-- Dropdown estilo "Assunto" para Tarefa -->
                        <div class="dropdown">
                          <button class="btn btn-sm btn-light dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fa-solid fa-share-nodes"></i>
                            {{ tarefa.user.nickname }}{% for usuario in tarefa.shared_with %} / {{ usuario.nickname }}{% endfor %}
                          </button>
                          <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                              <a class="dropdown-item" href="{{ url_for('main.share_tarefa', tarefa_id=tarefa.id) }}">
                                <i class="fa-solid fa-share-nodes"></i> Compartilhar
                              </a>
                            </li>
                          </ul>
                        </div>
                        <!-- Botão Adicionar Horas -->
                        <button class="btn btn-sm btn-outline-secondary add-hours-tarefa"
                                data-tarefa-id="{{ tarefa.id }}" title="Adicionar Horas">
                          <i class="fa-solid fa-clock"></i> {{ tarefa.horas|default(0) }}h
                        </button>
                      </div>
                    </li>
                  {% else %}
                    <li class="list-group-item text-muted">Nenhuma tarefa pendente.</li>
                  {% endfor %}
                </ul>                
                <!-- Botão Criar Tarefa -->
                <a href="{{ url_for('main.create_tarefa', assunto_id=assunto.id) }}" class="btn btn-primary">
                  <i class="fa-solid fa-plus"></i> Criar Tarefa
                </a>
              </div>              
            </div>
          </div>
        </div>
        {% else %}
        <p class="text-muted">Nenhum assunto cadastrado.</p>
        {% endfor %}
      </div>
    </div>

    <!-- Coluna Prazos -->
    <div class="col-lg-4">
      <h4 class="mb-3">Prazos</h4>
      <div class="row row-cols-1 g-3">
        {% for prazo in prazos %}
        <div class="col">
          <div class="card h-100">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <h5 class="mb-0 flex-grow-1" style="white-space: normal;">
                  {{ prazo.assunto }}
                </h5>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <div class="dropdown">
                  <button class="btn btn-sm btn-light dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fa-solid fa-share-nodes"></i>
                    {{ prazo.user.nickname }}
                    {% for usuario in prazo.shared_with %}
                      / {{ usuario.nickname }}
                    {% endfor %}
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                      <a class="dropdown-item" href="{{ url_for('main.share_prazo', prazo_id=prazo.id) }}">
                        <i class="fa-solid fa-share-nodes"></i> Compartilhar
                      </a>
                    </li>
                  </ul>
                </div>                
                <div class="d-flex align-items-center gap-2">
                  <form action="{{ url_for('main.toggle_status_prazo', prazo_id=prazo.id) }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-success" title="Concluir">
                      <i class="fa-solid fa-check"></i>
                    </button>
                  </form>
                  <a href="{{ url_for('main.edit_prazo', prazo_id=prazo.id) }}" class="btn btn-sm btn-warning" title="Editar">
                    <i class="fa-solid fa-pen-to-square"></i>
                  </a>
                  <form action="{{ url_for('main.delete_prazo', prazo_id=prazo.id) }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-danger" title="Excluir">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </form>
                </div>
              </div>
            </div>
            <div class="card-body">
              <p class="card-text mb-2" style="white-space: normal;">
                <strong>Processo:</strong> {{ prazo.processo }} |
                <strong>Cliente:</strong> {{ prazo.client.name }} |
                <strong>Data:</strong>
                {% if prazo.prazo %}
                  {{ prazo.prazo.strftime('%d/%m/%Y') }}
                {% else %}
                  Sem data
                {% endif %}
              </p>
              <!-- Botão de Horas (Prazo) -->
              <div class="d-flex justify-content-end">
                <button class="btn btn-sm btn-outline-secondary add-hours-prazo"
                        data-prazo-id="{{ prazo.id }}" title="Adicionar Horas">
                  <i class="fa-solid fa-clock"></i> {{ prazo.horas|default(0) }}h
                </button>
              </div>
            </div>
          </div>
        </div>
        {% else %}
        <p class="text-muted">Nenhum prazo cadastrado.</p>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Modais e Scripts de Adicionar Horas -->
<div class="modal fade" id="modalHorasPrazo" tabindex="-1" aria-labelledby="modalHorasPrazoLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formHorasPrazo" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="modalHorasPrazoLabel">Adicionar Horas ao Prazo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="inputHorasPrazo" class="form-label">Horas</label>
            <input type="number" step="0.1" class="form-control" id="inputHorasPrazo" name="horas" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="modalHorasTarefa" tabindex="-1" aria-labelledby="modalHorasTarefaLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formHorasTarefa" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="modalHorasTarefaLabel">Adicionar Horas à Tarefa</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="inputHorasTarefa" class="form-label">Horas</label>
            <input type="number" step="0.1" class="form-control" id="inputHorasTarefa" name="horas" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Sortable.js e Scripts "Adicionar Horas" -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var containerAssuntos = document.getElementById('assuntos-container');
    if (containerAssuntos) {
      new Sortable(containerAssuntos, {
        animation: 150,
        onEnd: function (evt) {
          // Cria um array com a nova ordem de cada card
          var ordem = [];
          var cards = containerAssuntos.querySelectorAll('[data-id]');
          cards.forEach(function(card, index) {
            var assuntoId = card.getAttribute('data-id');
            ordem.push({ id: assuntoId, sort_order: index });
          });
          console.log("Nova ordem enviada:", ordem);
          
          // Envia a nova ordem para o servidor via fetch
          fetch('{{ url_for("main.update_assuntos_order") }}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ordem: ordem })
          })
          .then(response => response.json())
          .then(data => {
            console.log("Resposta do servidor:", data);
            if (data.status !== 'ok') {
              console.error('Erro ao atualizar ordem:', data.message);
            }
          })
          .catch(error => console.error('Erro na requisição:', error));
        }
      });
    }
    
    // Scripts para os modais "adicionar horas"
    const btnsHorasPrazo = document.querySelectorAll('.add-hours-prazo');
    btnsHorasPrazo.forEach(function(btn) {
      btn.addEventListener('click', function() {
        const prazoId = this.getAttribute('data-prazo-id');
        const form = document.getElementById('formHorasPrazo');
        form.action = '/prazo/add_hours/' + prazoId;
        document.getElementById('inputHorasPrazo').value = '';
        const modalHorasPrazo = new bootstrap.Modal(document.getElementById('modalHorasPrazo'));
        modalHorasPrazo.show();
      });
    });

    const btnsHorasTarefa = document.querySelectorAll('.add-hours-tarefa');
    btnsHorasTarefa.forEach(function(btn) {
      btn.addEventListener('click', function() {
        const tarefaId = this.getAttribute('data-tarefa-id');
        const form = document.getElementById('formHorasTarefa');
        form.action = '/tarefa/add_hours/' + tarefaId;
        document.getElementById('inputHorasTarefa').value = '';
        const modalHorasTarefa = new bootstrap.Modal(document.getElementById('modalHorasTarefa'));
        modalHorasTarefa.show();
      });
    });
  });
</script>

{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\edit_assunto.html --
{% extends "base.html" %}
{% import "macros.html" as macros %}
{% block title %}Editar Assunto{% endblock %}
{% block content %}
<h2>Editar Assunto</h2>
<form method="POST" action="{{ url_for('main.edit_assunto', assunto_id=assunto.id) }}" class="needs-validation" novalidate>
  {{ form.hidden_tag() }}
  {{ macros.render_field(form.client_existing) }}
  {{ macros.render_field(form.client_new) }}
  {{ macros.render_field(form.nome_assunto) }}
  {{ macros.render_field(form.due_date) }}
  {{ macros.render_field(form.sort_order) }}
  <button type="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
</form>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\edit_client.html --
{% extends "base.html" %}
{% block title %}Editar Cliente - {{ client.name }}{% endblock %}
{% block content %}
<div class="container">
  <h2 class="text-center my-4">Editar Cliente</h2>
  <form method="POST">
    <div class="mb-3">
      <label for="name" class="form-label">Nome do Cliente</label>
      <input type="text" class="form-control" id="name" name="name" value="{{ client.name }}" required>
    </div>
    <div class="mb-3">
      <label for="number_interno" class="form-label">Número Interno</label>
      <input type="text" class="form-control" id="number_interno" name="number_interno" value="{{ client.number_interno }}">
    </div>
    <div class="mb-3">
      <label for="nif" class="form-label">NIF</label>
      <input type="text" class="form-control" id="nif" name="nif" value="{{ client.nif }}">
    </div>
    <div class="mb-3">
      <label for="address" class="form-label">Morada</label>
      <input type="text" class="form-control" id="address" name="address" value="{{ client.address }}">
    </div>
    <div class="mb-3">
      <label for="email" class="form-label">Email</label>
      <input type="email" class="form-control" id="email" name="email" value="{{ client.email }}">
    </div>
    <div class="mb-3">
      <label for="telephone" class="form-label">Telefone</label>
      <input type="text" class="form-control" id="telephone" name="telephone" value="{{ client.telephone }}">
    </div>
    <button type="submit" class="btn btn-primary">Salvar</button>
    <a href="{{ url_for('main.client_info', client_id=client.id) }}" class="btn btn-secondary">Cancelar</a>
  </form>
</div>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\edit_prazo.html --
{% extends "base.html" %}
{% import "macros.html" as macros %}
{% block title %}Editar Prazo{% endblock %}
{% block content %}
<h2>Editar Prazo</h2>
<form method="POST" action="{{ url_for('main.edit_prazo', prazo_id=prazo.id) }}" class="needs-validation" novalidate>
  {{ form.hidden_tag() }}
  {{ macros.render_field(form.client_existing) }}
  {{ macros.render_field(form.client_new) }}
  {{ macros.render_field(form.assunto) }}
  {{ macros.render_field(form.processo) }}
  {{ macros.render_field(form.prazo) }}
  {{ macros.render_field(form.comentarios) }}
  {{ macros.render_field(form.horas) }}  {# Campo para inserir manualmente as horas #}
  <button type="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
</form>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\edit_profile.html --
{% extends "base.html" %}
{% block title %}Editar Perfil{% endblock %}

{% block content %}
<div class="container my-4">
  <h2>Editar Perfil</h2>
  <form method="POST" action="{{ url_for('main.edit_profile') }}">
    {{ form.hidden_tag() }}
    <div class="mb-3">
      {{ form.nickname.label(class="form-label") }}
      {{ form.nickname(class="form-control") }}
    </div>
    <div class="mb-3">
      {{ form.email.label(class="form-label") }}
      {{ form.email(class="form-control") }}
    </div>
    <div class="mb-3">
      {{ form.profile_image.label(class="form-label") }}
      {{ form.profile_image(class="form-control") }}
      <small class="form-text text-muted">Informe o caminho ou URL da imagem.</small>
    </div>
    <button type="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
  </form>
</div>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\edit_tarefa.html --
{% extends "base.html" %}
{% import "macros.html" as macros %}
{% block title %}Editar Tarefa{% endblock %}
{% block content %}
<h2>Editar Tarefa</h2>
<form method="POST" action="{{ url_for('main.edit_tarefa', tarefa_id=tarefa.id) }}" class="needs-validation" novalidate>
  {{ form.hidden_tag() }}
  {{ macros.render_field(form.nome_tarefa) }}
  {{ macros.render_field(form.descricao) }}
  {{ macros.render_field(form.due_date) }}
  {{ macros.render_field(form.sort_order) }}
  {{ macros.render_field(form.horas) }}
  <button type="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
</form>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\historico.html --
{% extends "base.html" %}
{% block title %}Histórico do Cliente - {{ client.name }}{% endblock %}
{% block content %}
<div class="container">
  <h2>Histórico do Cliente: {{ client.name }}</h2>

  <!-- Seção de Assuntos e Tarefas -->
  <h3>Assuntos e Tarefas</h3>
  {% if client.assuntos %}
    <div class="accordion" id="accordionAssuntos">
      {% for assunto in client.assuntos %}
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingAssunto{{ assunto.id }}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAssunto{{ assunto.id }}" aria-expanded="false" aria-controls="collapseAssunto{{ assunto.id }}">
              {{ assunto.nome_assunto }} – 
              {% if assunto.due_date %}{{ assunto.due_date.strftime('%d/%m/%Y') }}{% else %}Sem data{% endif %} – 
              {{ 'Concluído' if assunto.is_completed else 'Pendente' }} – 
              Horas: {{ assunto.tarefas|map(attribute='horas')|sum }}h
            </button>
          </h2>
          <div id="collapseAssunto{{ assunto.id }}" class="accordion-collapse collapse" aria-labelledby="headingAssunto{{ assunto.id }}" data-bs-parent="#accordionAssuntos">
            <div class="accordion-body">
              <h6>Tarefas</h6>
              {% if assunto.tarefas %}
                <ul class="list-group">
                  {% for tarefa in assunto.tarefas %}
                    <li class="list-group-item">
                      <strong>{{ tarefa.nome_tarefa }}</strong> – {{ tarefa.descricao or '---' }}<br>
                      Data: {% if tarefa.due_date %}{{ tarefa.due_date.strftime('%d/%m/%Y') }}{% else %}Sem data{% endif %} – 
                      {{ 'Concluída' if tarefa.is_completed else 'Pendente' }} – 
                      Horas: {{ tarefa.horas }}h
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p>Nenhuma tarefa cadastrada para este assunto.</p>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p>Nenhum assunto cadastrado.</p>
  {% endif %}

  <hr>

  <!-- Seção de Prazos -->
  <h3>Prazos Judiciais</h3>
  <div class="row">
    <div class="col-md-6">
      <h4>Pendentes</h4>
      {% set prazos_pendentes = client.prazos_judiciais | selectattr("status", "equalto", False) | list %}
      {% if prazos_pendentes %}
        <ul class="list-group">
          {% for prazo in prazos_pendentes %}
            <li class="list-group-item">
              <strong>{{ prazo.assunto }}</strong> ({{ prazo.processo }})<br>
              Data: {% if prazo.prazo %}{{ prazo.prazo.strftime('%d/%m/%Y') }}{% else %}Sem data{% endif %} – 
              Horas: {{ prazo.horas }}h
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>Nenhum prazo pendente.</p>
      {% endif %}
    </div>
    <div class="col-md-6">
      <h4>Concluídos</h4>
      {% set prazos_concluidos = client.prazos_judiciais | selectattr("status", "equalto", True) | list %}
      {% if prazos_concluidos %}
        <ul class="list-group">
          {% for prazo in prazos_concluidos %}
            <li class="list-group-item">
              <strong>{{ prazo.assunto }}</strong> ({{ prazo.processo }})<br>
              Data: {% if prazo.prazo %}{{ prazo.prazo.strftime('%d/%m/%Y') }}{% else %}Sem data{% endif %} – 
              Horas: {{ prazo.horas }}h
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>Nenhum prazo concluído.</p>
      {% endif %}
    </div>
  </div>

  <hr>

  <div class="text-end">
    <a href="{{ url_for('main.clientes') }}" class="btn btn-secondary">Voltar à lista de clientes</a>
  </div>
</div>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\index.html --
{% extends "base.html" %}
{% block title %}AdGest{% endblock %}
{% block content %}
  <div class="d-flex justify-content-center align-items-center" style="height: 80vh;">
    <h1>AdGest</h1>
  </div>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\login.html --
{% extends "base.html" %}
{% import "macros.html" as macros %}
{% block title %}Login{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-md-6">
    <h2 class="mb-3">Login</h2>
    <form method="POST" class="needs-validation" novalidate>
      {{ form.hidden_tag() }}
      {{ macros.render_field(form.username) }}
      {{ macros.render_field(form.password) }}
      <div class="mb-3">
        {{ form.submit(class="btn btn-primary") }}
      </div>
    </form>
  </div>
</div>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\macros.html --
{% macro render_field(field) %}
  <div class="mb-3">
    {{ field.label(class="form-label") }}
    {{ field(class="form-control") }}
    {% if field.errors %}
      {% for error in field.errors %}
        <div class="text-danger">{{ error }}</div>
      {% endfor %}
    {% endif %}
  </div>
{% endmacro %}

{% macro render_summary_card(label, assuntos, tarefas, prazos) %}
  <div class="card mb-3">
    <div class="card-header">
      {{ label }}
    </div>
    <div class="card-body">
      {% if assuntos|length > 0 or tarefas|length > 0 or prazos|length > 0 %}
        {% if assuntos|length > 0 %}
          <h5>Assuntos</h5>
          <ul class="list-group list-group-flush">
            {% for a in assuntos %}
              <li class="list-group-item">
                <strong>{{ a.nome_assunto }}</strong> ({{ a.client.name }})
                <br>
                Data: {% if a.due_date %}{{ a.due_date.strftime('%d/%m/%Y') }}{% else %}Sem data{% endif %}
              </li>
            {% endfor %}
          </ul>
        {% endif %}
        {% if tarefas|length > 0 %}
          <h5 class="mt-3">Tarefas</h5>
          <ul class="list-group list-group-flush">
            {% for t in tarefas %}
              <li class="list-group-item">
                <strong>{{ t.nome_tarefa }}</strong>
                {% if t.descricao %}
                  - <em>{{ t.descricao }}</em>
                {% endif %}
                <br>
                Data: {% if t.due_date %}{{ t.due_date.strftime('%d/%m/%Y') }}{% else %}Sem data{% endif %}
                | Horas: {{ t.horas }}h
              </li>
            {% endfor %}
          </ul>
        {% endif %}
        {% if prazos|length > 0 %}
          <h5 class="mt-3">Prazos</h5>
          <ul class="list-group list-group-flush">
            {% for p in prazos %}
              <li class="list-group-item">
                <strong>{{ p.assunto }}</strong>
                {% if p.comentarios %}
                  - <em>{{ p.comentarios }}</em>
                {% endif %}
                <br>
                Processo: {{ p.processo }} | Data: {% if p.prazo %}{{ p.prazo.strftime('%d/%m/%Y') }}{% else %}Sem data{% endif %}
                | Status: {{ 'Concluído' if p.status else 'Pendente' }}
                | Horas: {{ p.horas }}h
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      {% else %}
        <p>Nenhum item pendente para esta data.</p>
      {% endif %}
    </div>
  </div>
{% endmacro %}


--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\notifications.html --
{% for notif in notifications %}
  <div class="notification-item">
    <p>{{ notif.message }}</p>
    {% if notif.type == 'share_invite' %}
      <a href="{{ url_for('main.respond_share', notif_id=notif.id, acao='accept') }}" class="btn btn-sm btn-success">Aceitar</a>
      <a href="{{ url_for('main.respond_share', notif_id=notif.id, acao='decline') }}" class="btn btn-sm btn-danger">Recusar</a>
    {% else %}
      <a href="{{ notif.link if notif.link else '#' }}" class="btn btn-sm btn-primary">Ver</a>
    {% endif %}
    <small class="text-muted">{{ notif.timestamp.strftime('%d/%m/%Y %H:%M') }}</small>
  </div>
{% else %}
  <p>Nenhuma notificação.</p>
{% endfor %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\notifications_historico.html --
{% extends "base.html" %}
{% block title %}Histórico de Notificações{% endblock %}
{% block content %}
<div class="container">
  <h2 class="my-4">Histórico de Notificações</h2>
  {% if notifications %}
    <ul class="list-group">
      {% for notif in notifications %}
        <li class="list-group-item">
          <strong>{{ notif.message }}</strong>
          <br><small class="text-muted">{{ notif.timestamp.strftime('%d/%m/%Y %H:%M') }}</small>
          {% if notif.link %}
            <br><a href="{{ notif.link }}" class="btn btn-sm btn-primary mt-1">Ver</a>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>Nenhuma notificação lida ainda.</p>
  {% endif %}
</div>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\prazos_judiciais.html --
{% extends "base.html" %}
{% import "macros.html" as macros %}
{% block title %}Criar Prazo Judicial{% endblock %}
{% block content %}
<h2>Criar Prazo Judicial</h2>
<form method="POST" class="needs-validation" novalidate>
  {{ form.hidden_tag() }}
  {{ macros.render_field(form.client_existing) }}
  {{ macros.render_field(form.client_new) }}
  {{ macros.render_field(form.assunto) }}
  {{ macros.render_field(form.processo) }}
  {{ macros.render_field(form.prazo) }}
  {{ macros.render_field(form.comentarios) }}
  <button type="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
</form>
<p><a href="{{ url_for('main.dashboard') }}" class="btn btn-link">Voltar</a></p>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\preview_client_csv.html --
{% extends "base.html" %}
{% block title %}Pré-visualização Clientes CSV{% endblock %}

{% block content %}
<div class="container my-4">
  <h2>Pré-visualização dos Clientes Importados</h2>
  
  {% if errors %}
    <div class="alert alert-danger">
      <h4>Erros encontrados:</h4>
      <ul>
        {% for error in errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
  
  <table class="table table-bordered">
    <thead>
      <tr>
        {% for col in registros[0].keys() %}
          <th>{{ col }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in registros %}
        <tr>
          {% for col in row.keys() %}
            <td>{{ row[col] }}</td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
  
  <form method="POST" action="{{ url_for('main.preview_client_csv') }}">
    <button type="submit" class="btn btn-success" {% if errors %}disabled{% endif %}>Confirmar Importação</button>
    {% if errors %}
      <p class="text-danger mt-2">Por favor, corrija os erros no arquivo CSV e refaça a importação.</p>
    {% endif %}
  </form>
</div>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\profile.html --
{% extends "base.html" %}
{% block title %}Perfil de {{ user.nickname }}{% endblock %}

{% block content %}
<div class="container my-4">
  <h2>Perfil de {{ user.nickname }}</h2>
  <div class="card">
    <div class="card-body">
      <p><strong>Usuário:</strong> {{ user.username }}</p>
      <p><strong>Nickname:</strong> {{ user.nickname }}</p>
      <p><strong>Email:</strong> {{ user.email }}</p>
      <p><strong>Papel:</strong> {{ user.role }}</p>
      {% if user.profile_image %}
        <img src="{{ url_for('static', filename='icons/' ~ user.profile_image) }}" alt="Imagem de perfil" class="img-thumbnail" style="max-width: 200px;">
      {% endif %}
    </div>
  </div>
  <a href="{{ url_for('main.edit_profile') }}" class="btn btn-primary mt-3">Editar Perfil</a>
</div>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\register.html --
{% extends "base.html" %}
{% import "macros.html" as macros %}
{% block title %}Registrar{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-md-6">
    <h2 class="mb-3">Registrar</h2>
    {% if get_flashed_messages(category_filter=["danger"]) %}
      <div class="alert alert-danger">
        {% for message in get_flashed_messages(category_filter=["danger"]) %}
          <p>{{ message }}</p>
        {% endfor %}
      </div>
    {% endif %}
    <form method="POST">
      {{ form.hidden_tag() }}
      <div class="mb-3">
        {{ form.username.label }}<br>
        {{ form.username(class="form-control") }}
      </div>
      <div class="mb-3">
        {{ form.nickname.label }}<br>
        {{ form.nickname(class="form-control") }}
      </div>
      <div class="mb-3">
        {{ form.email.label }}<br>
        {{ form.email(class="form-control") }}
      </div>
      <div class="mb-3">
        {{ form.password.label }}<br>
        {{ form.password(class="form-control") }}
      </div>
      <div class="mb-3">
        {{ form.role.label }}<br>
        {{ form.role(class="form-control") }}
      </div>
      <button type="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
    </form>    
  </div>
</div>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\share_assunto.html --
{% extends "base.html" %}
{% block title %}Compartilhar Assunto{% endblock %}
{% block content %}
  <h2>Compartilhar Assunto: {{ assunto.nome_assunto }}</h2>
  <form method="POST">
    {{ form.hidden_tag() }}
    <div class="mb-3">
      {{ form.shared_with.label }}<br>
      {{ form.shared_with(class="form-control") }}
    </div>
    <button type="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-link">Cancelar</a>
  </form>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\share_client.html --
{% extends "base.html" %}
{% block title %}Compartilhar Cliente{% endblock %}

{% block content %}
<div class="container">
  <h2 class="text-center my-4">Compartilhar Cliente: {{ client.name }}</h2>
  <form method="POST">
    {{ form.hidden_tag() }}
    
    <div class="mb-3">
      {{ form.shared_with.label(class="form-label") }}
      {{ form.shared_with(class="form-control") }}
    </div>
    
    <button type="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
    <a href="{{ url_for('main.clientes') }}" class="btn btn-secondary">Cancelar</a>
  </form>
  {% if form.errors %}
    <div class="alert alert-danger mt-3">
      {{ form.errors }}
    </div>
  {% endif %}
</div>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\share_prazo.html --
{% extends "base.html" %}
{% block title %}Compartilhar Prazo{% endblock %}
{% block content %}
  <h2>Compartilhar Prazo: {{ prazo.assunto }}</h2>
  <form method="POST">
    {{ form.hidden_tag() }}
    <div class="mb-3">
      {{ form.shared_with.label }}<br>
      {{ form.shared_with(class="form-control") }}
    </div>
    <button type="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-link">Cancelar</a>
  </form>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\share_tarefa.html --
{% extends "base.html" %}
{% block title %}Compartilhar Tarefa{% endblock %}
{% block content %}
  <h2>Compartilhar Tarefa: {{ tarefa.nome_tarefa }}</h2>
  <form method="POST">
    {{ form.hidden_tag() }}
    <div class="mb-3">
      {{ form.shared_with.label }}<br>
      {{ form.shared_with(class="form-control") }}
    </div>
    <button type="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-link">Cancelar</a>
  </form>
{% endblock %}

--------------------------------------------------------------------------------
-- Conteúdo do ficheiro: C:\Python\AdGest\app\templates\upload_client_csv.html --
{% extends "base.html" %}
{% block title %}Importar Clientes CSV{% endblock %}

{% block content %}
<div class="container my-4">
  <h2>Importar Clientes via CSV</h2>
  <form method="POST" enctype="multipart/form-data">
    {{ form.hidden_tag() }}
    <div class="mb-3">
      {{ form.csv_file.label(class="form-label") }}
      {{ form.csv_file(class="form-control") }}
    </div>
    <button type="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
  </form>
</div>
{% endblock %}

--------------------------------------------------------------------------------
